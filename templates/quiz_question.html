{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/quiz.css') }}">
{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="quiz-progress">
        Question {{ question.id }} of {{ total_questions }}
        <div class="progress-bar">
            <div class="progress" style="width: {{ (question.id / total_questions) * 100 }}%"></div>
        </div>
    </div>

    <div class="question-container">
        <h2>{{ question.stage }}</h2>
        <p class="question">{{ question.question }}</p>

        <div class="options">
            {% for option in question.options %}
            <button class="option-button" data-index="{{ loop.index0 }}">
                {{ option }}
            </button>
            {% endfor %}
        </div>

        <div class="feedback hidden">
            <div class="feedback-content">
                <div class="result-container">
                    <p class="result"></p>
                    <span class="correct-answer-text"></span>
                </div>
                <p class="explanation"></p>
            </div>

            <div class="story-section">
                <h3>Write Your Story</h3>
                <p class="story-prompt">{{ question.story_prompt }}</p>
                <textarea class="story-input" rows="6" placeholder="Write your story here..."></textarea>
                <button class="save-story-button">Save Story</button>
            </div>

            {% if question.id == total_questions %}
            <div class="final-actions">
                <div class="score-summary">
                    <h3>Your Final Score</h3>
                    <p class="score">{{ "%.1f"|format((progress.correct_answers / total_questions) * 100) }}%</p>
                    <p>You got {{ progress.correct_answers }} out of {{ total_questions }} questions correct!</p>
                </div>
                <a href="{{ url_for('quiz_results') }}" class="view-journey-button">View Your Complete Hero's Journey</a>
            </div>
            {% else %}
            <div class="action-buttons">
                <button class="next-button">Next Question</button>
                <a href="{{ url_for('quiz_results') }}" class="see-results-button" style="display: none;">See Results</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Function to handle next question navigation
    function setupNextButton(nextQuestionNum) {
        $('.next-button')
            .off('click')
            .on('click', function() {
                window.location.href = `/quiz/${nextQuestionNum}`;
            });
    }

    // Set up next button for current question if not last question
    {% if question.id != total_questions %}
    setupNextButton({{ question.id + 1 }});
    {% endif %}

    $('.option-button').click(function() {
        // Disable all buttons
        $('.option-button').prop('disabled', true);
        
        const selectedAnswer = $(this).data('index');
        const questionNum = {{ question.id }};
        
        // Send answer to server
        $.ajax({
            url: '{{ url_for("submit_answer") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                question_num: questionNum,
                answer: selectedAnswer
            }),
            success: function(response) {
                // Show feedback
                $('.feedback').removeClass('hidden');
                
                if (response.correct) {
                    $('.result').text('Correct!').addClass('correct');
                    $(`.option-button[data-index=${selectedAnswer}]`).addClass('correct');
                    $('.see-results-button').hide();
                    $('.correct-answer-text').hide();
                } else {
                    $('.result').text('Incorrect').addClass('incorrect');
                    $(`.option-button[data-index=${selectedAnswer}]`).addClass('incorrect');
                    $(`.option-button[data-index=${question.correct_answer}]`).addClass('correct');
                    $('.see-results-button').show();
                    $('.correct-answer-text').show().text(`Correct answer: ${question.options[question.correct_answer]}`);
                }
                
                $('.explanation').text(response.explanation);
                
                // Show story section
                $('.story-section').show();
                
                // Handle story submission
                $('.save-story-button').click(function() {
                    const story = $('.story-input').val();
                    $.ajax({
                        url: '{{ url_for("save_story") }}',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            question_num: questionNum,
                            story: story
                        }),
                        success: function() {
                            $('.save-story-button').prop('disabled', true).text('Story Saved!');
                        }
                    });
                });
            }
        });
    });
});
</script>
{% endblock %} 
